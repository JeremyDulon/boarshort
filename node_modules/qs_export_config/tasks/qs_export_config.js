module.exports = function(grunt) {
    var path = require('path');


    // Creat csv field with protected quotes
    function csvField(data)
    {
        return '"'+data.replace(/"/g,'""')+'"';
    }

    // Encode obj to csv with protected field quotes
    var json_to_properties = function(obj, prefix)
    {
        var txt = '';
        for( var i in obj)
        {
            if(typeof obj[i] == "string")
            {
                txt+=csvField(prefix+'['+JSON.stringify(i)+'] = ')+';'+csvField(obj[i])+'\n';
            }
            else
            {
                txt+= '\n'+json_to_properties(obj[i], prefix+'['+JSON.stringify(i)+']').trim()+'\n';
            }
        }
        return txt;
    }

    var path = require('path'),
        exec = require('child_process').exec,
        jsons = [],
        tpls = [],
        labels= [];

    // Initialize repo for build
    grunt.registerMultiTask('export_config', function() {
        var options = this.options({ config: '', output :'' });

        grunt.file.mkdir(options.output);
        var dest = grunt.file.expand(options.output);
        var filename = path.basename(options.config).replace('.js', '.csv');
        var json_data = grunt.file.readJSON(options.config);
        var txt =  json_to_properties(json_data,'');
        grunt.file.write(dest+'/'+filename,txt);
        grunt.log.writeln('Creating '+dest+'/'+filename);
    });
};

