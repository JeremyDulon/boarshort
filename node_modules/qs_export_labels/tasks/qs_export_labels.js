module.exports = function(grunt) {
    var path = require('path');


    // Creat csv field with protected quotes
    function csvField(data)
    {
        return '"'+data.replace(/"/g,'""')+'"';
    }

    // Encode obj to csv with protected field quotes
    var json_to_properties = function(obj, prefix)
    {
        var txt = '';
        for( var i in obj)
        {
            if(typeof obj[i] == "string")
            {
                txt+=csvField(prefix+'['+JSON.stringify(i)+'] = ')+';'+csvField(obj[i])+'\n';
            }
            else
            {
                txt+= '\n'+json_to_properties(obj[i], prefix+'['+JSON.stringify(i)+']')+'\n';
            }
        }
        return txt.replace(/\n\n+/g,'\n\n');
    }

    var path = require('path'),
        exec = require('child_process').exec,
        jsons = [],
        tpls = [],
        labels= [];

    // Initialize repo for build
    grunt.registerMultiTask('export_labels', function() {
        var options = this.options({ locales: [], output :'' });
        if(jsons.length==0)
        {
            jsons = grunt.file.expand(options.locales);
        }

        // Read jsons file to check for each label
        jsons.forEach(function(file)
        {
            grunt.file.mkdir(options.output);
            var dest = grunt.file.expand(options.output);
            var filename = path.basename(file).replace('.json', '.csv');
            var json_data = grunt.file.readJSON(file);
            var txt =  json_to_properties(json_data,'');
            //grunt.log.writeln(txt+' to '+dest+'/'+filename);
            grunt.file.write(dest+'/'+filename,txt);
            grunt.log.writeln('Creating '+dest+'/'+filename);
        });
    });
};

