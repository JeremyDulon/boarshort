module.exports = function(grunt) {
    var path = require('path');


    // Creat csv field with protected quotes
    function csvField(data)
    {
        return '"'+data.replace(/"/g,'""')+'"';
    }

    // Encode obj to csv with protected field quotes
    var json_to_properties = function(obj, prefix)
    {
        var txt = '';
        for( var i in obj)
        {
            if(typeof obj[i] == "string")
            {
                txt+=csvField(prefix+'['+JSON.stringify(i)+'] = ')+';'+csvField(obj[i])+'\n';
            }
            else
            {
                txt+= '\n'+json_to_properties(obj[i], prefix+'['+JSON.stringify(i)+']').trim()+'\n';
            }
        }
        return txt;
    }

    var path = require('path'),
        exec = require('child_process').exec,
        jsons = [],
        tpls = [],
        labels= [];


    // Initialize repo for build
    grunt.registerMultiTask('import_config', function() {
        var options = this.options({ config: '', output :'' });
        var S = require('string');

        grunt.log.writeln('Import '+options.config);
        var src = grunt.file.expand(options.output);
        var filename = path.basename(options.config).replace('.js', '.csv');
        var json_data = grunt.file.readJSON(options.config);
        var csv_data = grunt.file.read(src+'/'+filename);

        var data = S(csv_data).parseCSV(';','"', '"', "\n" )
        for(var i=0; i<data.length; i++)
        {
            if(data[i][0].length>0)
            {
                try
                {
                    eval('json_data'+data[i][0]+' '+JSON.stringify(data[i][1]));
                }
                catch(err)
                {
                    grunt.log.writeln('ERROR CSV: json_data'+data[i][0]+' '+JSON.stringify(data[i][1]));
                    exit;
                }
            }
        }
        grunt.file.write(options.config, JSON.stringify(json_data, ' ', "\t"));
        grunt.task.run('i18n');
    });
};

